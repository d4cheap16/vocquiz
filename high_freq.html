<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高頻率單字複習</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }
        .control-btn {
            transition: all 0.2s ease;
        }
        .control-btn.active {
            transform: scale(1.05);
            box-shadow: 0 4px 14px 0 rgb(0 0 0 / 10%);
        }
        .group-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .difficulty-btn-wrapper {
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            padding: 0.25rem 0.75rem;
            border: 2px solid transparent;
        }
        .difficulty-btn-wrapper.active {
             border-color: #facc15;
        }
        .difficulty-btn {
            color: #d1d5db; /* gray-300 */
        }
        .difficulty-btn-wrapper.active .difficulty-btn {
            color: #facc15; /* yellow-400 */
        }
        .difficulty-btn-wrapper:not(.disabled) {
            cursor: pointer;
        }
        .difficulty-btn-wrapper:not(.disabled):hover .difficulty-btn {
            color: #fde047; /* yellow-300 */
            transform: scale(1.1);
        }
        .difficulty-btn-wrapper.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .word-select {
            min-width: 150px;
            height: 40px; border: 2px solid #9ca3af;
            background-color: #f9fafb; border-radius: 0.75rem; vertical-align: middle;
            margin: 0 4px; padding: 2px 8px; appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em; cursor: pointer; transition: border-color 0.3s;
        }
        .word-select.correct { border-color: #10b981; background-color: #ecfdf5; }
        .word-select.incorrect { border-color: #ef4444; background-color: #fef2f2; }
        .word-pronounceable {
            transition: all 0.2s ease;
            display: flex; align-items: center;
            justify-content: center; border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); background-color: #e0f2fe;
            color: #0c4a6e;
            padding: 0.5rem 1rem; font-weight: 500; cursor: pointer;
        }
        .word-pronounceable:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15); }
        #word-options { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: center; padding: 1rem; border-radius: 0.75rem; background-color: #f3f4f6; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: 12px; max-width: 500px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="p-4 sm:p-8">
<div class="max-w-4xl mx-auto mb-4">
    <a href="https://sites.google.com/tcsh.hlc.edu.tw/d4cheap/home" 
       class="inline-block bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-300">
        &larr; 返回入口主頁
    </a>
</div>
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-10">
        <div id="quiz-container" class="space-y-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800">高頻率單字複習</h1>
            
            <div class="space-y-4 border-b border-gray-200 pb-6">
                <!-- User Info -->
                <div class="flex flex-wrap items-center justify-center gap-x-4 gap-y-4 text-gray-700">
                    <div class="flex flex-col items-center text-center sm:flex-row sm:space-x-2">
                        <label for="unit-select" class="font-medium mb-1 sm:mb-0">單元:</label>
                        <select id="unit-select" class="rounded-md border border-gray-300 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 w-64 sm:w-auto">
                            <option value="" selected disabled>--請選擇單元--</option>
                            <option disabled>--人物篇--</option>
                            <option value="test1">Test 1</option>
                            <option value="test2">Test 2</option>
                            <option disabled>--工作篇--</option>
                            <option value="test3">Test 3</option>
                            <option value="test4">Test 4</option>
                        </select>
                    </div>
                    <div class="flex flex-col items-center text-center sm:flex-row sm:space-x-2">
                        <label for="class-select" class="font-medium mb-1 sm:mb-0">班級:</label>
                        <select id="class-select" class="rounded-md border border-gray-300 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 w-64 sm:w-auto">
                             <option value="" selected disabled>--請選擇班級--</option>
                            <option value="知足">知足</option> 
                            <option value="感恩">感恩</option> 
                            <option value="善解">善解</option> 
                            <option value="包容">包容</option> 
                            <option value="大愛">大愛</option>
                        </select>
                    </div>
                    <div class="flex flex-col items-center text-center sm:flex-row sm:space-x-2">
                        <label for="seat-number" class="font-medium mb-1 sm:mb-0">座號:</label>
                        <input type="text" id="seat-number" class="w-20 rounded-md border border-gray-300 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center" placeholder="00" maxlength="10">
                    </div>
                </div>
        
                <!-- Group & Difficulty Selection -->
                <div class="space-y-3 pt-2">
                    <div class="flex items-center justify-center space-x-2 sm:space-x-4">
                        <label class="font-medium text-gray-700">選擇組別:</label>
                        <div id="group-selector" class="flex space-x-2 rounded-lg p-1 bg-gray-200">
                            <button data-group="groupA" class="control-btn group-btn px-4 sm:px-6 py-2 text-sm sm:text-base font-medium text-gray-600 rounded-md">Group A</button>
                            <button data-group="groupB" class="control-btn group-btn px-4 sm:px-6 py-2 text-sm sm:text-base font-medium text-gray-600 rounded-md">Group B</button>
                            <button data-group="groupC" class="control-btn group-btn px-4 sm:px-6 py-2 text-sm sm:text-base font-medium text-gray-600 rounded-md">Group C</button>
                            <button data-group="groupBonus" id="bonus-group-btn" class="hidden control-btn group-btn px-4 sm:px-6 py-2 text-sm sm:text-base font-medium text-yellow-500 bg-gray-800 rounded-md" title="傳說級挑戰">❓</button>
                        </div>
                    </div>
                    <div class="flex items-center justify-center space-x-2 sm:space-x-4">
                        <label class="font-medium text-gray-700">選擇難度:</label>
                        <div id="difficulty-selector" class="flex items-center space-x-2 text-3xl">
                             <button data-level="A2" class="control-btn difficulty-btn-wrapper disabled" title="A2 - 初級 (一顆星)"><span class="difficulty-btn">★</span></button>
                            <button data-level="B1" class="control-btn difficulty-btn-wrapper disabled" title="B1 - 中級 (兩顆星)"><span class="difficulty-btn">★ ★</span></button>
                            <button data-level="B2" class="control-btn difficulty-btn-wrapper disabled" title="B2 - 中高級 (三顆星)"><span class="difficulty-btn">★ ★ ★</span></button>
                            <button data-level="C1" class="control-btn difficulty-btn-wrapper disabled text-4xl" title="C1 - 高級 (四顆星)"><span class="difficulty-btn">★ ★ ★ ★</span></button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="quiz-area" class="hidden">
                <div class="text-center text-gray-600 p-2 mb-4">
                    <strong>作答指引：</strong> 請從下拉選單中選擇正確的單字。點擊下方的選項可聽發音與查看提示。
                </div>
                <div id="story-passage" class="text-lg leading-relaxed text-gray-800 bg-gray-50 rounded-lg p-4 sm:p-6 border border-gray-200"></div>
                <div class="border-t border-gray-200 pt-6 mt-6">
                    <details id="badge-hall-details">
                        <summary class="text-center bg-gray-500 text-white hover:bg-gray-600 py-3 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">
                            徽章殿堂 (點擊展開/收合)
                        </summary>
                        <div id="badge-hall-container" class="pt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        </div>
                    </details>
                </div>
                <div class="border-t border-gray-200 pt-6 mt-6">
                    <h2 class="text-xl font-bold text-gray-700 text-center mb-4">單字選項（點擊查看發音與例句）</h2>
                    <div id="word-options"></div>
                </div>
                <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
                    <button id="submitBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>檢查答案</button>
                    <button id="clearBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">清除答案</button>
                    <div id="admin-tools" class="hidden flex space-x-4">
                        <button id="adminFillBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">一鍵填答</button>
                    </div>
                </div>
                <div id="results-and-share" class="mt-8 text-center">
                    <div id="results" class="text-xl font-semibold mb-4"></div>
                    <button id="shareBtn" class="hidden bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">分享本次成績</button>
                </div>
                <div id="analysis-container" class="hidden mt-8">
                     <details id="analysis-details"><summary class="text-center bg-purple-600 text-white hover:bg-purple-700 py-3 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">檢討您的答案</summary><div id="incorrect-answers" class="pt-6 space-y-4"></div></details>
                </div>
            </div>
             <div id="welcome-message" class="text-center py-12">
                <h2 class="text-2xl font-semibold text-gray-700">請先選擇單元、組別與難度</h2>
                <p class="text-gray-500 mt-2">完成設定後，測驗內容將會顯示於此處。</p>
            </div>
        </div>
        
        <div id="dev-tools-panel" class="hidden border-t-4 border-red-500 pt-6 mt-8">
             <h2 class="text-2xl font-bold text-center text-red-700">開發者工具</h2>
             <div class="flex flex-wrap justify-center gap-4 mt-4">
                 <button id="unlockAllBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">一鍵解鎖所有徽章</button>
                 <button id="clearAllBtn" class="bg-red-800 hover:bg-red-900 text-white font-semibold py-2 px-4 rounded-lg">一鍵清除所有徽章</button>
                 <button id="testAchievementShare" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">測試「成就總覽」圖片</button>
                 <button id="testScoreShare" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">測試「成績單」圖片</button>
             </div>
        </div>

        <div class="border-t border-gray-200 pt-6 mt-8">
            <div class="flex justify-center items-start gap-4">
                 <details id="records-details" class="flex-1">
                    <summary class="text-center bg-indigo-600 text-white hover:bg-indigo-700 py-3 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">查看我的成績</summary>
                    <div id="records-container" class="pt-6 space-y-4">
                        <p id="records-status" class="text-center text-gray-500"></p>
                        <div id="records-list" class="space-y-4"></div>
                    </div>
                </details>
                <button id="share-achievements-btn" disabled class="flex-1 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none text-center bg-teal-600 text-white hover:bg-teal-700 py-3 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">分享學習成就</button>
            </div>
        </div>
    </div>

    <div id="hintModal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><div id="modal-content-inner" class="space-y-4"></div></div></div>
    <canvas id="shareCanvas" class="hidden" width="800" height="800"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel, query, where, doc, getDoc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 關鍵修改 1: 更改頁面辨識碼 ---
        const pageIdentifier = 'high_freq';
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // --- 關鍵修改 2: 更新為您新的 Firebase 設定碼 ---
        const firebaseConfig = {
          apiKey: "AIzaSyDefns_HT5RG6xHrZzoIQvc_pou4kViECo",
          authDomain: "vocquiz-5b984.firebaseapp.com",
          projectId: "vocquiz-5b984",
          storageBucket: "vocquiz-5b984.firebasestorage.app",
          messagingSenderId: "639712411937",
          appId: "1:639712411937:web:01a422b094452f866c3e60",
          measurementId: "G-VMW7MT1LES"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        setLogLevel('debug');
        
        let db, auth, userId;
        let localScores = [];
        let earnedBadges = {};
        const ADMIN_PASS_B64 = 'TWFLaU1hNzc3';

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) { console.error("Firebase initialization failed:", error); }

        async function signIn() {
            if (!auth) return;
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) { 
                console.error("Firebase authentication failed:", error); 
            }
        }
        
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                fetchScores();
                fetchBadges();
            } else {
                userId = null;
                localScores = [];
                earnedBadges = {};
                renderBadgeHall(); 
                updateBonusButtonVisibility();
            }
        });

        const allBadges = {
            perfect_score: { name: "滿分達人", icon: "🏆", description: "在任何測驗中獲得100分。" },
            high_achiever: { name: "高分好手", icon: "⭐", description: "在任何測驗中獲得90分(含)以上。" },
            effortful_learner: { name: "努力不懈", icon: "💪", description: "在任何測驗中獲得60分(含)以上。" },
            a2_explorer: { name: "探索者", icon: "🧭", description: "完成一個單元內所有組別的\"一顆星\"難度測驗（80分以上）。" },
            b1_voyager: { name: "旅行家", icon: "🗺️", description: "完成一個單元內所有組別的\"兩顆星\"難度測驗（80分以上）。" },
            conqueror: { name: "征服者", icon: "👑", description: "完成一個單元內所有組別的三顆星難度測驗(80分以上)。" },
            strong_one: { name: "真強者", icon: "💎", description: "完成一個單元內所有組別的四顆星難度測驗(80分以上)。" },
            english_monster: { name: "英文怪物", icon: "👹", description: "完成一個單元內所有組別的四顆星難度測驗(皆為滿分)。" },
            legend: { name: "傳說", icon: "🌌", description: "完成一個單元內所有常規測驗且皆為滿分。" },
            alien: { name: "外星人", icon: "👽", description: "在一個單元的傳說級(❓)挑戰中獲得滿分。" },
            unit_master: { name: "單元大師", icon: "🎖️", description: "在單一單元內，同時獲得「傳說」與「外星人」徽章。" },
            cute_cat: { name: "可愛貓貓", icon: "😺", description: "是的，你沒看錯，宇宙的盡頭是貓猫。恭喜你完成所有挑戰，這隻可愛的橘貓是你的了。" },
        };
        
        const wordDetails = {
            'test1': {
                'conscience':{pos:'n.', translation:'良心；良知', definition:"A person's moral sense of right and wrong, viewed as acting as a guide to one's behavior.", example:"David’s conscience pricked him because he was responsible for the big mistake.", example_tw:'大衛的良心譴責他，因為他要為那個大錯負責。'},
                'curiosity':{pos:'n.', translation:'好奇心', definition:'A strong desire to know or learn something.', example:"We were burning with curiosity to know what had happened.", example_tw:'我們充滿好奇心，渴望知道發生了什麼事。'},
                'discreet':{pos:'adj.', translation:'謹慎的；小心的', definition:"Careful and prudent in one's speech or actions, especially in order to keep something confidential or to avoid embarrassment.", example:"Helen was too discreet to mention the money in front of her father.", example_tw:'海倫非常謹慎，沒有在她父親面前提及那筆錢。'},
                'accompanied':{pos:'vt.', translation:'陪伴；陪同', definition:'To go somewhere with (someone) as a companion or escort.', example:"I’m really grateful that you accompanied me to the police station after I was robbed.", example_tw:'我真的很感激在我被搶劫後，你陪我到警察局。'},
                'creative':{pos:'adj.', translation:'有創造力的；創新的', definition:"Relating to or involving the imagination or original ideas, especially in the production of an artistic work.", example:"The manager is praised by the president of the company, for he is so creative and able to think of new and unique ideas.", example_tw:'這位經理受到公司總裁的稱讚，因為他非常有創造力，能夠想出新穎且獨特的點子。'},
                'deliberated':{pos:'vi.', translation:'仔細考慮；商議', definition:'To engage in long and careful consideration.', example:"The jury deliberated for six hours before reaching a verdict.", example_tw:'陪審團在達成裁決前商議了六個小時。'},
                'feature':{pos:'n.', translation:'特色；特徵', definition:'A distinctive attribute or aspect of something.', example:"The exciting car chase is the most impressive feature in the film.", example_tw:'這場刺激的飛車追逐是電影中最令人印象深刻的特色。'},
                'expert':{pos:'n.', translation:'專家', definition:'A person who has a comprehensive and authoritative knowledge of or skill in a particular area.', example:"Kevin is good at taking photos and is also an expert at planning a wedding.", example_tw:'凱文很會拍照，同時也是一位婚禮策劃專家。'},
                'Flocks':{pos:'n.', translation:'一群（人或動物）', definition:'A large number of people or a large group of birds, sheep, or goats.', example:"Flocks of tourists came to see the unique bridge, which was a great attraction.", example_tw:'成群的遊客前來觀看這座獨特的橋樑，它是一個很棒的景點。'},
                'biography':{pos:'n.', translation:'傳記', definition:"An account of someone's life written by someone else.", example:"A biography is an account of a person’s life written by someone else.", example_tw:'傳記是由他人撰寫的關於某個人一生的記述。'},
                'acquaintance':{pos:'n.', translation:'認識的人；點頭之交', definition:'A person one knows slightly, but who is not a close friend.', example:"I do not know Mr. Wang very well. He’s just a nodding acquaintance of mine.", example_tw:'我不是很了解王先生。他只是我的一位點頭之交。'},
                'behalf':{pos:'n.', translation:'代表；利益', definition:"As a representative of someone or in the interest of someone.", example:"The president can’t be here today, so I’m going to speak on his behalf.", example_tw:'總統今天不能出席，所以我將代表他發言。'},
                'competitive':{pos:'adj.', translation:'競爭的；有競爭力的', definition:'Relating to or characterized by competition; having a strong desire to win.', example:"Nowadays young people have to make more effort to fight for jobs in a highly competitive society.", example_tw:'現今的年輕人必須付出更多努力，才能在一個高度競爭的社會中爭取工作。'},
                'companion':{pos:'n.', translation:'同伴；夥伴', definition:'A person or animal with whom one spends a lot of time or with whom one travels.', example:"Mr. Anderson is not much of a companion for me. I don’t like his way of doing things.", example_tw:'安德森先生對我來說不算個好夥伴。我不喜歡他做事的方式。'},
                'activate':{pos:'vt.', translation:'啟動；使活化', definition:'To make something, such as a device, start working or become operative.', example:"Treading on any part of this floor will activate the alarm system.", example_tw:'踩到這片地板的任何一部分都會啟動警報系統。'}
            },
            'test2': {
                'fussy':{pos:'adj.', translation:'挑剔的；龜毛的', definition:"Hard to please; very particular or detailed about one's needs or requirements.", example:"He’s very fussy about food. There are many things he doesn’t eat.", example_tw:'他對食物非常挑剔，有很多東西他不吃。'},
                'cunning':{pos:'adj.', translation:'狡猾的；奸詐的', definition:"Having or showing skill in achieving one's ends by deceit or evasion.", example:"David is said to be as cunning as a fox. He can’t be trusted.", example_tw:'據說大衛像狐狸一樣狡猾。他不能被信任。'},
                'obstinate':{pos:'adj.', translation:'固執的；頑固的', definition:"Stubbornly refusing to change one's opinion or chosen course of action, despite attempts to persuade one to do so.", example:"It is said that her grandfather is as obstinate as a mule.", example_tw:'據說她的祖父像騾子一樣固執。'},
                'optimistic':{pos:'adj.', translation:'樂觀的', definition:'Hopeful and confident about the future.', example:"I’ve applied for the job, but I’m not optimistic about my chances of getting it.", example_tw:'我已經申請了那份工作，但我對自己獲得這份工作的機會並不樂觀。'},
                'intelligent':{pos:'adj.', translation:'聰明的；有才智的', definition:'Having or showing intelligence, especially of a high level.', example:"Human beings are considered more intelligent than all the other animals.", example_tw:'人類被認為比所有其他動物都更有智慧。'},
                'gorgeous':{pos:'adj.', translation:'華麗的；極其漂亮的', definition:'Beautiful; very attractive.', example:"The show featured many gorgeous dancing girls. The audience was fascinated by them.", example_tw:'那場表演有許多美豔的舞者。觀眾們都被她們迷住了。'},
                'indifferent':{pos:'adj.', translation:'漠不關心的；冷淡的', definition:'Having no particular interest or sympathy; unconcerned.', example:"He’s always indifferent to the suffering of others. He never cares about others.", example_tw:'他總是對別人的痛苦漠不關心。他從不關心別人。'},
                'nuisance':{pos:'n.', translation:'討厭的人事物；麻煩事', definition:'A person, thing, or circumstance causing inconvenience or annoyance.', example:"He was nothing but a nuisance and a rascal; therefore, nobody liked him.", example_tw:'他不過是個討厭鬼和無賴；因此，沒有人喜歡他。'},
                'modesty':{pos:'n.', translation:'謙虛；謙遜', definition:"The quality of having a moderate or humble view of one's importance.", example:"She does a lot of work for the poor, but modesty prevents her from talking about it.", example_tw:'她為窮人做了很多工作，但謙虛使她不願談論此事。'},
                'intimate':{pos:'adj.', translation:'親密的；密切的', definition:'Closely acquainted; familiar.', example:"The president of the enterprise is on intimate terms with important people in the government.", example_tw:'該企業的總裁與政府要員關係密切。'},
                'nonsense':{pos:'n.', translation:'胡說；廢話', definition:'Spoken or written words that have no meaning or make no sense.', example:"To say that this law will not affect our profits is total nonsense. It is not true at all.", example_tw:'說這條法律不會影響我們的利潤完全是胡說八道。這根本不是真的。'},
                'alienation':{pos:'n.', translation:'疏離感；孤立', definition:'The state or experience of being isolated from a group or an activity to which one should belong or in which one should be involved.', example:"The old man has a strong sense of alienation from society. He often feels lonely.", example_tw:'這位老人對社會有強烈的疏離感。他時常感到孤獨。'},
                'ignorant':{pos:'adj.', translation:'無知的；不了解的', definition:'Lacking knowledge or awareness in general; uneducated or unsophisticated.', example:"I’m afraid I’m rather ignorant about computers. I need someone to help me.", example_tw:'恐怕我對電腦相當無知。我需要有人幫我。'},
                'freak':{pos:'adj.', translation:'異常的；反常的', definition:'A very unusual and unexpected event or situation.', example:"It’s a freak weather condition, with snow falling in the middle of summer.", example_tw:'這是一個反常的天氣狀況，夏天居然下起了雪。'},
                'innocence':{pos:'n.', translation:'天真；純潔；無罪', definition:"The state, quality, or fact of being innocent of a crime or offense; lack of guile or corruption.", example:"In their innocence, they believed everything they were told.", example_tw:'他們很天真，別人告訴他們的任何事都相信。'}
            },
             'test3': {
                'dismay':{pos:'n.', translation:'沮喪；驚愕', definition:"A feeling of consternation and distress, typically caused by something unexpected.", example:"They were filled with dismay by the outcome of the trial. The result was disappointing.", example_tw:'他們對審判的結果充滿了沮喪。這個結果令人失望。'},
                'halt':{pos:'n.', translation:'停止；暫停', definition:'A suspension of movement or activity, typically a temporary one.', example:"Production has come to a halt owing to the lack of raw materials.", example_tw:'由於缺乏原料，生產已陷入停頓。'},
                'dismissed':{pos:'vt.', translation:'解僱；開除', definition:'To officially remove someone from their job; to fire.', example:"The Wangs dismissed the cook because of his poor service.", example_tw:'王家人因為廚師的服務不佳而解僱了他。'},
                'interview':{pos:'n.', translation:'會面；面談；面試', definition:'A meeting of people face to face, especially for consultation or formal discussion.', example:"They asked for an interview with the manager. They wanted to see him in person.", example_tw:'他們要求與經理會面。他們想親自見他。'},
                'bound':{pos:'adj.', translation:'有義務的；受束縛的', definition:'Required by law or duty to do something.', example:"You are not legally bound to answer these questions. You don’t have to do so.", example_tw:'法律上你沒有義務回答這些問題。你不必這麼做。'},
                'commutes':{pos:'vi.', translation:'通勤', definition:"To travel some distance between one's home and place of work on a regular basis.", example:"She commutes between Oxford and London; she travels a lot every day.", example_tw:'她在牛津和倫敦之間通勤；她每天都要長途跋涉。'},
                'conducted':{pos:'vt.', translation:'進行；實施', definition:'To organize and carry out an event or activity.', example:"The company conducted a survey to find out local reaction to the leisure center.", example_tw:'該公司進行了一項調查，以了解當地對休閒中心的反應。'},
                'adhere':{pos:'vi.', translation:'遵守；堅持', definition:'To believe in and follow the practices of.', example:"They failed to adhere to our original agreement. In short, they broke their promise.", example_tw:'他們未能遵守我們最初的協議。簡而言之，他們違背了諾言。'},
                'overwhelming':{pos:'adj.', translation:'壓倒性的；巨大的', definition:'Very great in amount; very strong.', example:"We have received an overwhelming number of letters and phone calls offering help.", example_tw:'我們收到了數量極大的信件和電話來表示願意提供幫助。'},
                'ambition':{pos:'n.', translation:'野心；抱負', definition:'A strong desire to do or to achieve something, typically requiring determination and hard work.', example:"To realize his ambition to become a famous singer, Chris has to practice as much as he can.", example_tw:'為了實現成為著名歌手的抱負，克里斯必須盡可能地多加練習。'},
                'mounted':{pos:'vi.', translation:'增加；增長', definition:'To grow larger or more numerous; increase.', example:"The tension between the two parties mounted as their interests clashed.", example_tw:'隨著雙方利益衝突，他們之間的緊張關係加劇了。'},
                'defeat':{pos:'n.', translation:'失敗；戰敗', definition:'The fact of losing a battle, game, or other competition.', example:"Many people were surprised by the mayor’s defeat in the election.", example_tw:'許多人對市長在選舉中的失敗感到驚訝。'},
                'committed':{pos:'vt.', translation:'犯（罪）；做（錯事）', definition:'To perpetrate or carry out (a mistake, crime, or immoral act).', example:"To our surprise, he committed a crime. We had thought he was a law-abiding man.", example_tw:'令我們驚訝的是，他犯了罪。我們本以為他是一個守法的人。'},
                'exhausted':{pos:'adj.', translation:'筋疲力竭的', definition:'Very tired; drained of one\'s physical or mental resources.', example:"She was completely exhausted by her long flight. It was really tiring.", example_tw:'長途飛行使她筋疲力竭。那真的很累人。'},
                'abandoned':{pos:'vt.', translation:'放棄；中止', definition:'To cease to support or look after (someone); desert.', example:"The search for the missing child was abandoned after two weeks.", example_tw:'搜尋失蹤兒童的行動在兩週後被中止了。'}
            },
            'test4': {
                'unemployment':{pos:'n.', translation:'失業', definition:'The state of being without a paid job.', example:"Millions of people were thrown into unemployment when the economy failed. They all suddenly lost their jobs.", example_tw:'當經濟衰退時，數百萬人陷入失業。他們都突然失去了工作。'},
                'patrol':{pos:'n.', translation:'巡邏', definition:'The act of keeping watch over an area by regularly walking or traveling around it.', example:"Many cities are trying to cut down on crime by increasing the number of police on patrol.", example_tw:'許多城市正試圖透過增加巡邏警力來減少犯罪。'},
                'routine':{pos:'n.', translation:'例行公事；慣例', definition:'A sequence of actions regularly followed; a fixed program.', example:"The secret agent checks under the car for bombs as a matter of routine. He does that every time before starting his car.", example_tw:'這名特務每次發動汽車前都會檢查車底是否有炸彈，這已成為例行公事。'},
                'selected':{pos:'vt.', translation:'挑選；選擇', definition:'To carefully choose as being the best or most suitable.', example:"She selected a diamond ring from the collection.", example_tw:'她從收藏品中挑選了一枚鑽戒。'},
                'Tough':{pos:'adj.', translation:'艱難的；強硬的', definition:'Strong enough to withstand adverse conditions or rough handling; demanding or difficult.', example:"Tough measures need to be taken to protect the environment.", example_tw:'需要采取強硬的措施來保護環境。'},
                'perspectives':{pos:'n.', translation:'觀點；視角', definition:'A particular attitude toward or way of regarding something; a point of view.', example:"The two leaders have different perspectives on how to solve the hunger problem.", example_tw:'兩位領導人對於如何解決飢餓問題有著不同的觀點。'},
                'embraces':{pos:'vt.', translation:'擁抱；欣然接受', definition:'To accept or support (a belief, theory, or change) willingly and enthusiastically.', example:"The mother always embraces her son tenderly to show her affection for him.", example_tw:'這位母親總是溫柔地擁抱她的兒子，以表達她對他的疼愛。'},
                'task':{pos:'n.', translation:'任務；工作', definition:'A piece of work to be done or undertaken.', example:"It will take much effort to finish the difficult task. We’ll have to work together.", example_tw:'完成這項艱鉅的任務需要付出很多努力。我們必須同心協力。'},
                'resume':{pos:'vt.', translation:'重新開始；繼續', definition:'To begin to do or pursue (something) again after a pause or interruption.', example:"We’ll stop now and resume working at three o’clock.", example_tw:'我們現在先停下來，三點再繼續工作。'},
                'presume':{pos:'vt.', translation:'推測；假定', definition:'To suppose that something is the case on the basis of probability.', example:"Tom didn’t say when he’d return, but I presume that he’ll be back for dinner.", example_tw:'湯姆沒說他何時回來，但我推測他會回來吃晚餐。'},
                'vacancies':{pos:'n.', translation:'職缺；空缺', definition:'An unoccupied position or job.', example:"We still have vacancies for shop assistants, but all the other positions have been filled.", example_tw:'我們還有店員的職缺，但所有其他職位都已滿了。'},
                'strike':{pos:'vi.', translation:'罷工', definition:'To engage in a temporary stoppage of work as a protest.', example:"The union has voted to strike for a pay increase of 10%.", example_tw:'工會投票決定為爭取加薪10%而罷工。'},
                'deprive':{pos:'vt.', translation:'剝奪', definition:'To prevent (a person or place) from having or using something.', example:"This law will deprive us of our most basic rights. We consider it unconstitutional.", example_tw:'這條法律將剝奪我們最基本的權利。我們認為它違憲。'},
                'retrieve':{pos:'vt.', translation:'取回；找回', definition:'To get or bring (something) back; regain possession of.', example:"She tried to get into the building, but it was already too late to retrieve her belongings.", example_tw:'她試圖進入大樓，但要取回她的財物為時已晚。'},
                'consigned':{pos:'vt.', translation:'交付；托運', definition:"To deliver (something) to a person's custody, typically in order for it to be sold.", example:"The goods will be consigned to the auction house by next week.", example_tw:'這批貨物將在下週前交付給拍賣行。'}
            }
        };

        const vocabulary = {
            'test1': {
                'groupA': {
                    words: ['conscience', 'curiosity', 'discreet', 'accompanied', 'creative'],
                    stories: [
                        { level: 'A2', text: "A strong feeling of **curiosity** filled seven-year-old Leo. He was in the dusty attic with his best friend Sam, looking for pirate treasure. His friend Sam **accompanied** him on this important mission. They didn't find gold, but they saw a beautiful wooden box on a high shelf. Leo is a very **creative** boy; he loves to imagine things and immediately thought it must be a magic box from a faraway land. He knew it was his mom's and he shouldn't touch it. \"We have to be quiet,\" he whispered, trying to be very **discreet** as he slowly opened the lid. Inside, there were no jewels, only old photos of his mom when she was a little girl. That night, Leo felt strange and couldn't sleep. His **conscience** wouldn't leave him alone, because keeping secrets from his mom felt wrong, and he decided to tell her everything in the morning." },
                        { level: 'B1', text: "My **conscience** started bothering me the moment we decided to break the rules, but I pushed the feeling away. Our history project was on the school's founder, and my partner Mia had a genuinely **creative** idea: instead of a boring report, we would build a 3D model of the forbidden clock tower. Our research in the library was a dead end, which only fueled our **curiosity** about what secrets the tower held within its stone walls. Of course, I **accompanied** her on this adventure; she was my best friend and I couldn't let her go alone. I did insist, however, that we had to be incredibly **discreet**, waiting until after the last bell and making sure the janitor was on the other side of the campus. The thrill of discovery was quickly replaced by concern when we found a window broken from the inside, a sign that we weren't the only ones who had been there." },
                        { level: 'B2', text: "An artist working at the edge of contemporary thought must often be intensely **discreet** when discussing the more controversial aspects of their work, especially when corporate funding is involved. This is a lesson bio-artist Anya knows well. Her installations are famously **creative**, often blurring the line between living organisms and inert materials in ways that both fascinate and disturb the art world. When I **accompanied** her through her sterile, lab-like studio for a profile piece, I felt less like a journalist and more like a privileged observer in a scientist's inner sanctum. My professional **curiosity** was piqued by her evasive answers regarding her primary investors, hinting at a larger, untold story. Her work is not meant to be passively observed; it is conceived as an active, and often uncomfortable, challenge to the public's moral **conscience**." },
                        { level: 'C1', text: "On a high-stakes assignment, particularly one involving whistleblowers, the person by whom you are **accompanied** is more than a colleague; they are your silent partner in a complex dance of risk and revelation. Our investigation into the Pharmalife data-falsification scandal demanded an exceptionally **creative** methodology, as the official narrative was a tightly woven, internally consistent fabrication. To protect our source, a terrified but resolute data scientist from within the company, every interaction had to be almost paranoid in its level of **discreet**, utilizing encrypted channels and pre-arranged dead drops that left no discernible electronic or physical trail. While professional **curiosity** is the engine of any worthwhile investigation, it is ultimately journalistic **conscience** that must navigate the profound ethical labyrinth of protecting a source's life while exposing a truth that could save thousands." }
                    ]
                },
                'groupB': {
                    words: ['deliberated', 'feature', 'expert', 'Flocks', 'biography'],
                    stories: [
                        { level: 'A2', text: "Last Saturday, large **Flocks** of families and children went to the city museum because it was a free-admission day. The main **feature** of the museum for most kids was the giant Tyrannosaurus rex skeleton on the first floor; it was bigger than a school bus. Our tour guide, a real dinosaur **expert**, told us that the T-rex lived millions of years ago. In another room, our teacher showed us a book. It was a **biography** about the scientist who discovered the first T-rex fossil. She said our school's teachers **deliberated** for a long time before choosing this museum for our field trip, and they made a great choice." },
                        { level: 'B1', text: "Reading the new **biography** of our town's founder, the famous inventor Sarah Chen, gave the museum director an inspiring idea for a new exhibit. The museum board **deliberated** for weeks, mostly discussing the budget and timeline, before finally giving the project a green light. To ensure all the historical details were accurate, they hired a history **expert** from the local university as a consultant. The main **feature** of the planned exhibit will be a life-sized, interactive model of Sarah Chen's first workshop, where visitors can try out replicas of her inventions. The museum hopes that **Flocks** of students and tourists will be drawn to this new, engaging display when it opens next spring." },
                        { level: 'B2', text: "The gallery's board of directors **deliberated** for months, weighing the potential for public outrage against their commitment to artistic freedom, before approving the controversial exhibition. To provide academic weight and guide public interpretation, they hired a renowned art **expert**, Dr. Isla Reyes, to write the catalogue essay. The most talked-about **feature** of the show is a massive, room-sized sculpture made entirely from recycled plastic bottles, meant to critique consumer culture. A recently published **biography** of the artist reveals that this theme is deeply rooted in his childhood poverty, providing crucial context for the work's aggressive political message. The curator now fully expects **Flocks** of both passionate supporters and vocal protestors to descend upon the gallery on opening night." },
                        { level: 'C1', text: "Dr. Alistair Finch, the preeminent **expert** on 18th-century political history, has just published a book that has caused a significant rupture in the academic community. The central **feature** of his argument involves a radical reinterpretation of General Cornwall's financial dealings, suggesting they were motivated by personal gain rather than imperial loyalty. His book is less a traditional **biography** and more a forensic analysis of power, using advanced data analysis on previously ignored shipping manifests. The Royal Historical Society's prestigious awards committee **deliberated** for an entire weekend, an unprecedented length, before ultimately deciding to deny the book its top prize due to its provocative claims. His work has, unsurprisingly, drawn **Flocks** of both acolytes and detractors, fundamentally reshaping the discourse around the empire's final years." }
                    ]
                },
                'groupC': {
                    words: ['acquaintance', 'behalf', 'competitive', 'companion', 'activate'],
                    stories: [
                        { level: 'A2', text: "My main **companion** on my first day working at the cafe was the big, noisy coffee machine that stood in the corner. Before the cafe opened, the manager showed me how to **activate** the main alarm system with a special code. He was very busy with paperwork, so he later asked me to sign for a large milk delivery on his **behalf**. I met another barista named Sara. For now, she is just a new **acquaintance**, but she seems very friendly and showed me where the extra coffee beans were stored. It feels like a **competitive** place to work, as everyone wants to see who can make the best latte art for the customers." },
                        { level: 'B1', text: "I'm slowly making new friends after a month at my new job. A friendly **acquaintance** from the design department, Mark, often joins me for lunch, and he's become a great office **companion** who helps make the stressful days more fun. The job itself is very **competitive**; our team is constantly compared to other teams based on performance, which pushes everyone to do their best. Yesterday was a huge milestone for me. My manager was sick, so she asked me to lead the weekly client presentation on her **behalf**. It was a big sign of trust. Now, my main task for the afternoon is to figure out how to **activate** my professional account for the new company-wide software." },
                        { level: 'B2', text: "In such a fiercely **competitive** corporate environment, where everyone is vying for the same limited promotion slots, genuine friendships are rare. I was therefore surprised when a casual **acquaintance** from the IT department sent me an informal message warning me about a critical system-wide update. He told me that we would need to **activate** a new two-factor authentication protocol by morning, or we'd be locked out of the network entirely. Later that day, my director, who was stuck in a massive traffic jam, called and asked me to run an emergency project briefing on her **behalf**. In these high-pressure moments, you quickly realize your only true **companion** is your own skill set and your ability to adapt under pressure." },
                        { level: 'C1', text: "To speak on **behalf** of an entire nation at an international summit, even in a junior capacity, is a profoundly humbling and terrifying experience. The lead ambassador had been unexpectedly recalled for consultations, leaving me to deliver our official response to the trade proposal. The geopolitical landscape is relentlessly **competitive**, with each delegation employing intricate strategies to gain an advantage. In such a tense environment, a brief, reassuring conversation with a casual **acquaintance**, a seasoned journalist I knew from a previous posting, can feel like a lifeline. My final instruction was clear: if negotiations stalled past midnight, I was authorized to **activate** Article 7 of the proposed treaty, a move that would trigger binding international arbitration. In that silent, cavernous hall, my only **companion** was the immense weight of that impending decision." }
                    ]
                },
                'groupBonus': {
                    words: ['activate', 'behalf', 'conscience', 'companion', 'feature', 'deliberated', 'discreet', 'competitive', 'creative', 'Flocks', 'accompanied', 'biography', 'curiosity', 'acquaintance', 'expert'],
                    story: { level: 'C2', text: "My professional life has been a study in navigating the precarious line between legality and morality, but nothing prepared me for the crisis of **conscience** presented by the Atheria case. The tech industry is ruthlessly **competitive**, a fact I knew well, but Atheria's internal politics were a class apart. I was brought in as an external **expert** in corporate espionage, tasked with identifying a high-level mole. The board of directors had **deliberated** for weeks, their indecision fueled by paranoia, before finally authorizing my clandestine investigation. My sole trusted **companion** in this labyrinth was a retired intelligence officer, a mentor whose guidance was my only anchor.\n\nMy initial professional **curiosity** led me down a rabbit hole of encrypted data streams. A key **feature** of the mole's methodology was their ability to bypass conventional security protocols, which suggested an intimate knowledge of the system's architecture. To counter this, my approach had to be exceptionally **creative**; I designed a virtual honeypot, a false data repository that, when accessed, would **activate** a silent trace protocol. I was **accompanied** on the late-night stakeouts only by the hum of the servers. The operation had to be impeccably **discreet**, as even a whisper of my true purpose would compromise everything.\n\nThe breakthrough came via a casual **acquaintance** within Atheria's legal department, who, under the guise of professional courtesy, provided a crucial piece of the puzzle. It turned out the mole wasn't a corporate spy selling secrets. Instead, they were leaking documents to the press—a self-published digital **biography** of corporate malfeasance. The leaks exposed unethical practices, and **Flocks** of journalists were beginning to circle. I realized with a chilling certainty that I was not acting on the **behalf** of justice, but merely on behalf of a board desperate to protect its reputation. The mission was no longer about stopping a crime, but about enabling a cover-up." }
                }
            },
            'test2': {
                'groupA': {
                    words: ['fussy', 'cunning', 'obstinate', 'optimistic', 'intelligent'],
                    stories: [
                        { level: 'A2', text: "In the forest lived a very **cunning** fox who was famous for his clever tricks. Nearby lived an old badger who was very **obstinate**; if he decided something, nothing could change his mind. The fox wanted to get the badger's tasty-looking berries. The badger, however, was also very **fussy** about his food and would not share with anyone. One day, a wise and **intelligent** owl told the fox, \"You need a good plan.\" The fox remained **optimistic** that he would succeed. He decided to create a fake treasure map that led the badger away from his berry bush for the entire afternoon. The plan worked perfectly." },
                        { level: 'B1', text: "As a young architect, I'm generally **optimistic** about every new project, but Mr. Harrison is proving to be a unique challenge. He is an incredibly **intelligent** and successful businessman, but when it comes to design, he is the most **obstinate** client I've ever met; he refuses to consider any ideas that are not his own. Furthermore, he is extremely **fussy** about materials, rejecting samples for the slightest imperfection in color or texture. I suspect his negotiation tactics are quite **cunning**, as he often makes seemingly small requests that later reveal themselves to be major, costly changes to the plan. Despite the difficulties, I believe we can find a solution that satisfies his demanding nature." },
                        { level: 'B2', text: "Senator Thorne is a formidable opponent. She is sharp, strategically brilliant, and undeniably **intelligent**, capable of debating complex policy on the fly. However, her public persona masks a deeply **obstinate** refusal to compromise on even the most minor legislative points, a trait that frustrates her colleagues. Privately, she is known to be **fussy** about her staffing, demanding a level of perfection that many find impossible to achieve. Her political maneuvers are often described as **cunning**, employing procedural loopholes to outwit her rivals. Despite facing such a challenging adversary in the upcoming election, I remain **optimistic**, believing that our message of unity and collaboration will ultimately resonate more strongly with the voters." },
                        { level: 'C1', text: "Grandmaster Valeriy was a paradox. On one hand, he was the most **intelligent** player of his generation, possessing a near-supernatural intuition for the chessboard's intricate possibilities. Yet, he was notoriously **fussy** about his playing conditions, demanding a specific brand of water and a precise room temperature, or he would refuse to play. Many of his rivals whispered that his strategies were not just brilliant, but borderline **cunning**, often luring them into elegant, inescapable traps that defied conventional chess theory. This reputation was compounded by his **obstinate** adherence to a highly unorthodox opening move, a move that all other experts deemed statistically inferior, yet he continued to win with it. Despite his eccentricities and the psychological warfare he waged, I remained **optimistic** about my chances in our upcoming championship match, for I had discovered a subtle flaw in his seemingly invincible defense." }
                    ]
                },
                'groupB': {
                    words: ['gorgeous', 'indifferent', 'nuisance', 'modesty', 'intimate'],
                    stories: [
                        { level: 'A2', text: "Everyone agrees that the movie star, Anna Bell, is **gorgeous**. She wears beautiful dresses on the red carpet. Despite her beauty and fame, she is known for her **modesty**; she is always polite and never likes to talk about how successful she is. She has a very small, **intimate** group of friends from before she was famous, and they often eat pizza at her house. For Anna, the constant photographers who follow her everywhere are a big **nuisance** that she really dislikes. She sometimes seems **indifferent** to the cameras, looking straight ahead, but she always stops to talk to her real fans." },
                        { level: 'B1', text: "For the newly famous singer, Alex, the biggest **nuisance** of his new life is the complete loss of privacy and the endless online gossip. He tries to appear **indifferent** to the negative comments, telling interviewers that he doesn't read them, but it's harder than it looks. In person, his natural **modesty** shines through; he always gives credit to his bandmates and seems genuinely surprised by his own success. He values the quiet, **intimate** dinners with his family far more than any glamorous award show party. Of course, it also helps his career that his fans think his singing voice is absolutely **gorgeous**, which keeps the concert tickets selling out." },
                        { level: 'B2', text: "The legendary actor, Julian Croft, grants only one **intimate**, in-depth interview per decade, and only to a journalist he trusts. He is famous for being totally **indifferent** to Hollywood trends, award ceremonies, and box office numbers, which he sees as distractions from the art of acting. Some younger critics mistake this behavior for arrogance, but those who have worked with him say it stems from a deep-seated **modesty** and a desire for authenticity. He has famously described fame as a \"necessary **nuisance**\" that accompanies his craft, a price he pays to do what he loves. He now dedicates most of his time to his **gorgeous** countryside estate, finding peace in gardening, far from the public eye and the demands of stardom." },
                        { level: 'C1', text: "In the relentless glare of the 21st-century public eye, genuine **modesty** is a casualty of fame; it is often perceived by the public as a calculated PR strategy rather than a sincere character trait. A celebrity must construct an **intimate** inner circle as a bulwark against the psychologically invasive nature of modern stardom. The very fame that was sparked by a **gorgeous** film performance or a critically acclaimed album becomes a perpetual, low-grade **nuisance** that shadows their every private moment. Consequently, the only sustainable psychological response for many is to become profoundly **indifferent** to the vacillating tide of public opinion—a necessary detachment. This creates an armored persona, a carefully maintained fiction essential for psychic survival in an utterly unreal environment." }
                    ]
                },
                'groupC': {
                    words: ['nonsense', 'alienation', 'ignorant', 'freak', 'innocence'],
                    stories: [
                        { level: 'A2', text: "Tom insisted on his **innocence** when the class pet, a hamster named Pip, went missing from its cage. He told the teacher that the accusation against him was complete **nonsense** because Pip was his favorite animal in the whole school. It turned out that a **freak** gust of wind from an open window had blown the cage door open the day before. For a few hours, Tom felt a sad sense of **alienation** from his friends because some of them whispered that he did it. The teacher reminded everyone that they were **ignorant** of the true facts and needed to investigate together, not just blame the first person they suspected." },
                        { level: 'B1', text: "The police detective knew he had to dismiss most of the town gossip about the vandalism at the bakery as pure **nonsense**, but the pressure to make an arrest was high. The accused teenager felt a growing sense of **alienation** from the community, as even adults who had known him for years began to avoid eye contact. His public defender argued that the prosecution's entire case was built upon a **freak** coincidence of him simply being in the wrong place at the wrong time. She claimed the town was **ignorant** of the boy's actual character, judging him unfairly based on his family's reputation. Her closing argument powerfully focused on the boy's fundamental **innocence** and the complete lack of any credible evidence against him." },
                        { level: 'B2', text: "The plaintiff's legal team argued that the public remains willfully **ignorant** of the complex realities of their industry, making them susceptible to journalistic sensationalism. The corporation's CEO, meanwhile, projected a carefully crafted image of offended **innocence** throughout the highly publicized libel trial. A **freak** power surge at a critical moment had corrupted a key evidence server, making the recovery of incriminating digital files nearly impossible. The CEO's lawyers masterfully used this to portray the journalist's complex financial analysis as incomprehensible **nonsense** to the jury. This high-profile lawsuit has unfortunately caused a significant professional **alienation** between the defendant journalist and her more conservative former colleagues who feel she overstepped." },
                        { level: 'C1', text: "The research team's professional **alienation** was swift and brutal following the publication of their findings on the \"Volkov Anomaly.\" Their paper detailed a **freak** cosmological signal that appeared to defy the Standard Model of physics, a cornerstone of our current scientific understanding. The established scientific community largely dismissed their meticulously collected data as instrumental **nonsense** or, worse, a statistical artifact born from wishful thinking. The team's lead author, Dr. Lena Volkov, countered that to remain deliberately **ignorant** of such a profound and persistent anomaly was an abdication of scientific duty itself. The entire episode served as a harsh reminder that the supposed **innocence** of empirical research is often a carefully constructed myth, susceptible to the same dogmas and power structures as any other human endeavor." }
                    ]
                },
                'groupBonus': {
                    words: ['fussy', 'gorgeous', 'nonsense', 'indifferent', 'innocence', 'intimate', 'modesty', 'cunning', 'obstinate', 'optimistic', 'freak', 'intelligent', 'alienation', 'ignorant', 'nuisance'],
                    story: { level: 'C2', text: "To attempt a definitive psychological portrait of the architect Silas Croft is to confront a labyrinth of contradictions. The public remembers him for the **gorgeous**, soaring structures that defined a generation's skyline, yet the man himself remains an enigma. His early correspondence reveals a brilliantly **intelligent** mind, but one already marked by an **obstinate** refusal to compromise on his aesthetic principles—a trait colleagues initially mistook for the artistic **innocence** of a young genius. Even in his student years, he remained steadfastly **optimistic** about his radical visions, dismissing critiques from established figures as irrelevant **nonsense**.\n\n The catalyst for his legendary retreat from public life was reportedly a **freak** structural failure at his most ambitious project—a minor, non-fatal incident that nonetheless shattered his belief in his own infallibility. Following this, he became pathologically **fussy** about his privacy, viewing any journalistic inquiry not merely as an annoyance, but as a profound personal **nuisance**. This self-imposed exile fostered a deep **alienation** from the very society he had once so ambitiously sought to shape. He became willfully **ignorant** of contemporary architectural discourse, refusing to read journals or attend symposiums.\n\nWas this retreat an act of profound **modesty**, a sincere rejection of a fame he found hollow? Or was it, as some revisionist historians suggest, a **cunning** strategy to cultivate an aura of mystery, thereby inflating his legacy? The only glimpses into his later mindset come from a handful of **intimate** letters to his sister, in which he appears almost completely **indifferent** to his own monumental reputation, writing only of gardening and chess. This complex figure challenges our desire for simple narratives, leaving us to ponder the elusive nature of a great and troubled mind." }
                }
            },
            'test3': {
                'groupA': {
                    words: ['dismay', 'halt', 'dismissed', 'interview', 'bound'],
                    stories: [
                        { level: 'A2', text: "To Dan's great **dismay**, his boss called him into the office for a serious talk in the middle of his shift. It wasn't a normal **interview** to discuss his work; he could tell the news was bad from the manager's sad expression. The manager explained that the entire factory's production would come to a **halt** by the end of the week because of money problems. This meant that Dan, along with fifty other hardworking employees, was officially **dismissed** from his job. He knew he was **bound** to find a new job as soon as possible, because his family depended on his income to pay for rent and food." },
                        { level: 'B1', text: "I had been preparing for the promotional **interview** for weeks, feeling confident that the senior analyst position was mine. You can, therefore, imagine my absolute **dismay** when my director informed me that, due to a new company strategy, our entire department's operations were coming to an immediate **halt**. My current role, along with my team's, was officially **dismissed**, effective at the end of the month. While they generously offered me a different position in another department, I knew I wasn't legally **bound** to accept what was essentially a demotion. It was a harsh and unexpected end to that chapter of my career, forcing me to rethink my future." },
                        { level: 'B2', text: "As a department manager, I am contractually **bound** to uphold and implement company policy, even when I fundamentally disagree with it. To the collective **dismay** of our entire division, the announcement of a company-wide restructuring brought all our key projects to a sudden and demoralizing **halt**. Our director, a man I deeply respected and had worked with for over a decade, was **dismissed** without ceremony in a brief, impersonal email. I had a formal mentorship **interview** scheduled with him for the very next day to discuss my five-year career plan—a meeting that will now, of course, never happen. The situation is grim, and the uncertainty has sent employee morale plummeting to an all-time low." },
                        { level: 'C1', text: "The CEO was publicly **dismissed** in a brutal, early-morning board meeting, a calculated sacrificial lamb offered up to appease shareholder **dismay** after the catastrophic collapse of the merger. This single executive decision brought the company’s ambitious five-year strategic plan to a definitive **halt**, effectively erasing billions in projected value overnight. Ironically, I had conducted a lengthy, in-depth **interview** with him just last month for a feature in a major business journal, during which he confidently and eloquently outlined the very plan that now lay in ruins. As the company's general counsel, I am now legally and ethically **bound** by fiduciary duty to manage the catastrophic and complex legal fallout, a task I would not wish upon my worst enemy." }
                    ]
                },
                'groupB': {
                    words: ['commutes', 'conducted', 'adhere', 'overwhelming', 'ambition'],
                    stories: [
                        { level: 'A2', text: "Every morning, I **commutes** to the university on a bus that is always crowded with other students, a trip that takes about an hour. My main **ambition** for being here is to study hard so that I can become a doctor someday and help people. In my first biology class, our professor **conducted** a simple but very interesting experiment to show us how plants get water. He also told us that it is very important that all students **adhere** to the class rules, like always being on time and finishing our homework. The number of books I need to read for my classes is **overwhelming**, but I am very excited to start learning." },
                        { level: 'B1', text: "My **ambition** to graduate from university without any student debt means that I have to work 20 hours a week at a busy coffee shop. Sometimes, the pressure from trying to balance difficult classes with my work schedule feels completely **overwhelming**, and I get very tired. Every day, I **commutes** for over an hour each way on the train, and I use that precious time to do most of my required reading. Last week, my study group **conducted** a poll for our marketing class to better understand the spending habits of college students. This lifestyle is challenging, and I know I have to strictly **adhere** to my detailed weekly schedule, or I will quickly fall behind in my studies." },
                        { level: 'B2', text: "The sheer volume of raw data from our initial surveys was **overwhelming**; my research team and I had thousands of detailed responses to codify and analyze. Over the past year, we **conducted** a longitudinal study on the socio-economic effects of urban renewal in our nation's capital. As researchers, we had to strictly **adhere** to the university's rigorous ethical protocols, ensuring the anonymity and confidentiality of all participants. My personal **ambition** is to have the findings of this intensive research published in a respected academic journal before I graduate. Because I can't afford the high rent prices downtown, I **commutes** for nearly two hours each day from a suburb, a draining but necessary reality for many graduate students." },
                        { level: 'C1', text: "My doctoral thesis controversially argues that many seminal works in my field fail to strictly **adhere** to the available empirical evidence, instead perpetuating a narrative based on outdated assumptions. This central **ambition**—to challenge the established orthodoxy with new quantitative analysis—has been the defining purpose of my graduate studies. For my primary research, I **conducted** a comprehensive meta-analysis of three decades of declassified economic data from postwar Europe. As I **commutes** to the university campus for my final thesis defense, the cumulative weight of six years of relentless work, research, and writing feels absolutely **overwhelming**. This journey has been less an academic exercise and more a profound test of intellectual and personal endurance against incredible odds." }
                    ]
                },
                'groupC': {
                    words: ['mounted', 'defeat', 'committed', 'exhausted', 'abandoned'],
                    stories: [
                        { level: 'A2', text: "The little blue soldiers were completely **exhausted** after their long march across the entire living room carpet to the enemy's side. The tension **mounted** as they approached the red army's big pillow fort. The battle was short. The red commander had **committed** a big mistake by leaving the main entrance completely unguarded. After a quick attack, the red army had to accept **defeat**. The children who were playing felt a little sad looking at all the **abandoned** toy soldiers that were left behind on the \"battlefield\" after the game was over and it was time for dinner." },
                        { level: 'B1', text: "The feeling of **defeat** was bitter and shocking as our platoon was forced to retreat under heavy fire from the enemy. Our captain, a man we all trusted, had **committed** a grave tactical error, leading us directly into a well-planned ambush in the valley. We were all completely **exhausted**, having marched for two full days with very little rest or food. As we scrambled to fall back to a safer position, the pressure **mounted** with every enemy advance and the sound of gunfire. In our rush, we had to leave our fortified camp completely **abandoned**, along with most of our precious supplies and personal letters from home." },
                        { level: 'B2', text: "As the siege of the city entered its third grueling month, the tension within the walls **mounted** to an unbearable level. The defending soldiers were not only physically **exhausted** from constant vigilance and meager rations, but their morale was beginning to crumble. A final, desperate attempt to break the siege by launching a surprise attack ended in a catastrophic **defeat** in the fields outside the city. Fearing the inevitable and brutal final assault, the city's governor **committed** an act of high treason by attempting to negotiate a secret surrender for his own safety. When his plot was discovered by loyal guards, he was forced to flee, leaving the city's defenses in chaos and effectively **abandoned** by their leader." },
                        { level: 'C1', text: "Most military historians concur that General Valerius **committed** a fatal, uncharacteristic strategic error at the pivotal Battle of Silver Creek. His premature deployment of his elite cavalry reserves, a move that went against established military doctrine, led directly to the decisive **defeat** of his previously undefeated Third Legion. By that point in the arduous campaign, his legionnaires were profoundly **exhausted**, having endured a brutal, week-long forced march through hostile territory with inadequate supply lines. As the legion's exposed flank began to collapse under enemy pressure, a strategic panic **mounted** and cascaded throughout the ranks. The ensuing chaotic retreat resulted in the entire supply train, including vital artillery, being **abandoned** to the enemy—a logistical catastrophe from which Valerius's campaign never recovered." }
                    ]
                },
                'groupBonus': {
                    words: ['halt', 'dismay', 'dismissed', 'interview', 'bound', 'commutes', 'conducted', 'adhere', 'overwhelming', 'ambition', 'mounted', 'defeat', 'committed', 'exhausted', 'abandoned'],
                    story: { level: 'C2', text: "In the unforgiving calculus of politics, there is no honorable discharge; there is only victory or the long shadow of **defeat**. Our campaign began with such soaring **ambition**, fueled by a charismatic candidate and what we believed was an unassailable policy platform. I, as campaign manager, **conducted** what was considered the most thorough opposition research in a decade. However, as the election entered its final weeks, the external pressure and internal strife **mounted** exponentially. The logistical and strategic demands became **overwhelming**, leaving the entire senior staff physically and emotionally **exhausted**.\n\nThe unraveling began during a live, prime-time **interview**. Our candidate, under the intense lights and relentless questioning, **committed** a catastrophic verbal gaffe—a slip of the tongue so profound it was impossible to spin or walk back. The immediate effect was a complete **halt** to our fundraising momentum. To our collective **dismay**, major donors and key endorsements simply **abandoned** us overnight. Though I knew the cause was lost, I felt **bound** by a sense of professional loyalty to see the campaign through to its bitter end. We were forced to **adhere** to a facade of optimism, a grim performance for the remaining true believers.\n\nOn election night, the candidate **dismissed** us all via a terse, impersonal email before the final results were even officially called. My final **commutes** from the now-empty headquarters was a silent, solitary journey, the city lights blurring past as I reflected on the brutal finality of it all." }
                }
            },
            'test4': {
                'groupA': {
                    words: ['unemployment', 'patrol', 'routine', 'selected', 'Tough'],
                    stories: [
                        { level: 'A2', text: "Every morning, Officer Dave follows the same **routine**: he wakes up at 5 a.m., makes a strong cup of coffee, and puts on his clean uniform. He was **selected** from a large group of applicants to join the city's police force last year. His main job is to **patrol** the downtown area, walking through the streets to make sure everyone is safe and that all the shops are secure. It can be a **Tough** job, especially when the weather is bad or when he has to deal with difficult people. He often sees people struggling with **unemployment**, and he tries to help by telling them about a local center that offers job support and free meals." },
                        { level: 'B1', text: "After a long and difficult period of **unemployment**, I was incredibly relieved to be hired as a security guard at a large factory on the edge of town. It's a **Tough** job that requires me to be alert for eight hours straight, mostly at night. My nightly **routine** involves checking all the locks on the gates, monitoring the security cameras, and making a two-mile walking **patrol** around the entire perimeter of the property every two hours. I was part of a small group of people **selected** for this position because of my previous experience in the military, which prepared me for this kind of responsibility and discipline." },
                        { level: 'B2', text: "The recent spike in the city's **unemployment** rate, caused by the closure of the main steel mill, has forced the local government to make some **Tough** decisions regarding its budget and public services. To address the rise in property crime, the police chief has doubled the number of officers on nightly **patrol** in the most affected neighborhoods. A specially **selected** task force of social workers and city planners is now working to create new job training programs. For many families who have lost their income, the simple daily **routine** of packing lunches and going to work has been painfully disrupted, creating a sense of instability throughout the community." },
                        { level: 'C1', text: "Our sociological study focuses on the cyclical nature of urban decay, a process often triggered by mass **unemployment** following the collapse of a region's primary industry. We **selected** this particular district for our case study due to its stark statistical profile. One of the most visible municipal responses to the ensuing social instability has been an intensified police presence, with a near-constant **patrol** in areas now deemed \"high-risk.\" This policy, while intended to reassure, often disrupts the community's established social **routine** and can exacerbate feelings of marginalization. Formulating an effective and humane policy response presents a **Tough** governance challenge, requiring a delicate balance between law enforcement and community investment that few cities have successfully achieved." }
                    ]
                },
                'groupB': {
                    words: ['perspectives', 'embraces', 'task', 'resume', 'presume'],
                    stories: [
                        { level: 'A2', text: "Our main **task** for our school project this week is to create a large poster about our city's history, which is actually a lot of fun. I **presume** it will take us about a week to finish it properly because we need to draw and write a lot. Our group leader, Maria, is very good with people; she **embraces** all the different ideas from the team members and makes everyone feel included. It's important for us to listen to each other's **perspectives** so we can combine our best ideas to make the poster. We are taking a short break for lunch now, and we will **resume** our work at 1 p.m. this afternoon." },
                        { level: 'B1', text: "I was very happy to learn on my first day that my new company **embraces** new ideas and feedback, even from interns like me. In our first team meeting, we all shared our unique **perspectives** on the new marketing campaign, and the manager seemed to genuinely listen to everyone. My first official **task** is to research and summarize customer feedback from the last business quarter. A fire drill unexpectedly interrupted our meeting, but we were able to **resume** our important discussion in the afternoon. I **presume** my manager is giving me this initial research project to see how I handle data and to test my analytical skills before giving me more responsibilities." },
                        { level: 'B2', text: "The most difficult challenge of the project merger was reconciling the widely different **perspectives** and work cultures of the two teams that were being combined. As the lead manager, my immediate **task** was to establish a common ground and a shared goal to unite them. I had to **presume** that everyone, despite their initial resistance and skepticism, was ultimately acting in good faith and wanted the project to succeed. We took a necessary recess after a particularly heated debate, and when we **resume** the workshop an hour later, the tone was noticeably more constructive. Ultimately, the project's long-term success will depend on whether this newly formed team truly **embraces** a unified, collaborative culture." },
                        { level: 'C1', text: "When we **resume** the emergency board meeting after a tense, silent lunch, the atmosphere in the room was thick with unspoken disagreements and strategic positioning. My primary **task** as chairwoman was not merely to follow the agenda, but to steer the conversation toward a viable consensus—a formidable challenge given the high stakes. The very survival of the company depends on whether it fully **embraces** the proposed, and frankly radical, pivot to sustainable technology. In doing so, I had to synthesize wildly divergent **perspectives**, from the cold, hard pragmatism of the Chief Financial Officer to the fervent idealism of the head of R&D. I could only **presume** that the CEO's prolonged, strategic silence was a calculated move to gauge the board's conviction before he would finally lend his influential support to one side." }
                    ]
                },
                'groupC': {
                    words: ['vacancies', 'strike', 'deprive', 'retrieve', 'consigned'],
                    stories: [
                        { level: 'A2', text: "Our company's warehouse has many **vacancies** right now for new workers because it is a very busy time of year, and we need more help. Yesterday, a huge order of electronics was packaged and **consigned** to a big customer in Japan. My main job for the day was to use a forklift to **retrieve** the correct boxes from the highest shelves in the building. Some of the older workers are planning to **strike** next month for better pay and longer breaks. The manager told us in a meeting that a long work stoppage would **deprive** everyone of their salary, which made everyone worried." },
                        { level: 'B1', text: "The factory union has officially voted to **strike** if their demands aren't met by Friday, and everyone is feeling the tension. The company is already struggling, with several **vacancies** on the production line that the company is struggling to fill. Management sent a letter saying that this action will **deprive** the company of the ability to fulfill its contracts. Yesterday, a large shipment of finished goods was **consigned** to the port for international delivery. Before it left, I had to **retrieve** a specific crate that had been loaded by mistake." },
                        { level: 'B2', text: "A full-scale national logistics **strike** would effectively **deprive** our factories of the essential components we need for production, potentially shutting us down for weeks. In anticipation of this, we have already **consigned** our most valuable and time-sensitive inventory to secure, off-site storage facilities that are not dependent on the national union. My primary mission this week, a task of immense importance, is to **retrieve** critical assets from a key supplier who unexpectedly declared bankruptcy yesterday. This ongoing crisis has made it nearly impossible to fill the numerous executive **vacancies** in our supply chain division, as no one wants to join a company in the middle of such a major disruption." },
                        { level: 'C1', text: "The most critical issue during the industrial dispute was a shipment of temperature-sensitive pharmaceuticals that had been **consigned** to a humanitarian aid mission in a war-torn country. The union's illegal picket line, which blocked all access to the distribution center, made it physically impossible for the company to **retrieve** this vital, life-saving cargo. The corporation's legal team effectively argued in court that this was a deliberate tactic to **deprive** the company of its public goodwill and to create leverage through a manufactured humanitarian crisis. The fallout from the bitter, month-long **strike** has been catastrophic for both sides. The numerous leadership **vacancies** left by the subsequent firings have now been filled by non-union contractors, creating a volatile and deeply resentful workplace for the foreseeable future." }
                    ]
                },
                'groupBonus': {
                    words: ['unemployment', 'patrol', 'routine', 'selected', 'Tough', 'perspectives', 'embraces', 'task', 'resume', 'presume', 'vacancies', 'strike', 'deprive', 'retrieve', 'consigned'],
                    story: { level: 'C2', text: "My mayoral **routine** is no longer a matter of civic ceremonies and budget meetings; it has been distilled into a single, all-consuming **task**: preventing this city from spiraling into collapse. The catastrophic rise in **unemployment** after the mill closure has left thousands without hope and has created a volatile social landscape. We now face the imminent threat of a general **strike**, a move that would paralyze what little economic activity remains. My administration has **selected** a small, agile team to manage the crisis, but every decision is a **Tough** one, fraught with political peril. We are constantly working to **retrieve** emergency funds from a reluctant state government, while simultaneously trying not to **deprive** our citizens of the few essential services we can still afford.\n\nMy nightly walk through the city center, which feels less like a mayoral visit and more like a solitary **patrol**, reveals the grim reality: shuttered storefronts and an unnerving quiet. I have to synthesize the wildly divergent **perspectives** of my constituents, from the desperate factory workers to the fearful small business owners. One must **presume**, I suppose, that this is the essence of leadership in a downturn. Rather than retreat into city hall, my administration **embraces** a philosophy of radical transparency. Yesterday, in a symbolic and deeply painful gesture, we **consigned** the historic furniture from the city's grandest public buildings to an auction house. The funds raised are a pittance, but we must try everything. The sheer number of commercial **vacancies** downtown is a constant, visible reminder of our plight. Our only hope is that by averting the strike, we can begin the long, arduous process to **resume** some semblance of normal economic life." }
                }
            }
        };

        const dom = {
            unitSelect: document.getElementById('unit-select'),
            groupSelector: document.getElementById('group-selector'),
            difficultySelector: document.getElementById('difficulty-selector'),
            storyPassage: document.getElementById('story-passage'),
            wordOptions: document.getElementById('word-options'),
            submitBtn: document.getElementById('submitBtn'),
            clearBtn: document.getElementById('clearBtn'),
            resultsDiv: document.getElementById('results'),
            shareBtn: document.getElementById('shareBtn'),
            analysisContainer: document.getElementById('analysis-container'),
            incorrectAnswersDiv: document.getElementById('incorrect-answers'),
            hintModal: document.getElementById('hintModal'),
            modalContent: document.getElementById('modal-content-inner'),
            closeModalBtn: document.querySelector('.close-btn'),
            recordsList: document.getElementById('records-list'),
            recordsStatus: document.getElementById('records-status'),
            classSelect: document.getElementById('class-select'),
            seatNumberInput: document.getElementById('seat-number'),
            quizArea: document.getElementById('quiz-area'),
            welcomeMessage: document.getElementById('welcome-message'),
            bonusGroupBtn: document.getElementById('bonus-group-btn'),
            shareAchievementsBtn: document.getElementById('share-achievements-btn'),
            badgeHallContainer: document.getElementById('badge-hall-container'),
            adminTools: document.getElementById('admin-tools'),
            adminFillBtn: document.getElementById('adminFillBtn'),
            devToolsPanel: document.getElementById('dev-tools-panel'),
            devToolsBtn: document.getElementById('devToolsBtn'),
            unlockAllBtn: document.getElementById('unlockAllBtn'),
            clearAllBtn: document.getElementById('clearAllBtn'),
            testAchievementShare: document.getElementById('testAchievementShare'),
            testScoreShare: document.getElementById('testScoreShare'),
        };

        let state = {
            currentUnit: '',
            currentGroup: null,
            currentDifficulty: null,
            currentWords: [],
            correctAnswers: {},
            currentScore: 0,
            earnedBadgesForSharing: [],
        };

        const updateBadgesInFirestore = async () => {
            if (!userId) return;
            const badgeRef = doc(db, `artifacts/${appId}/public/data/user_badges`, userId);
            try {
                await setDoc(badgeRef, { badges: earnedBadges });
            } catch (e) {
                console.error("Error updating badges:", e);
            }
        };
        
        const checkAchievements = async (score) => {
            const newlyEarned = [];
            const addBadge = (key) => {
                let uniqueKey = key;
                const generalBadges = ['perfect_score', 'high_achiever', 'effortful_learner', 'cute_cat'];
                if (!generalBadges.includes(key)) {
                    uniqueKey = `${key}_${state.currentUnit}`;
                }

                if (!earnedBadges[uniqueKey]) {
                    const badgeData = allBadges[key];
                    if (badgeData) {
                         newlyEarned.push({key, ...badgeData});
                    }
                    earnedBadges[uniqueKey] = true;
                }
            };

            if (score === 100) addBadge('perfect_score');
            if (score >= 90) addBadge('high_achiever');
            if (score >= 60) addBadge('effortful_learner');

            const checkLevelMastery = (unitKey, targetLevel, scoreThreshold, badgeKey) => {
                if (earnedBadges[`${badgeKey}_${unitKey}`]) return;
                const scoresForLevel = localScores.filter(s => s.unitKey === unitKey && s.level === targetLevel);
                const allGroupsInUnit = Object.keys(vocabulary[unitKey]).filter(g => g !== 'groupBonus');
                const passedGroups = new Set(scoresForLevel.filter(s => s.score >= scoreThreshold).map(s => s.group));
                if (passedGroups.size === allGroupsInUnit.length) {
                    addBadge(badgeKey);
                }
            };

            checkLevelMastery(state.currentUnit, 'A2', 80, 'a2_explorer');
            checkLevelMastery(state.currentUnit, 'B1', 80, 'b1_voyager');
            checkLevelMastery(state.currentUnit, 'B2', 80, 'conqueror');
            checkLevelMastery(state.currentUnit, 'C1', 80, 'strong_one');
            checkLevelMastery(state.currentUnit, 'C1', 100, 'english_monster');

            const legendBadgeKey = `legend_${state.currentUnit}`;
            if (!earnedBadges[legendBadgeKey]) {
                const allScoresForUnit = localScores.filter(s => s.unitKey === state.currentUnit);
                const allTests = [];
                const groups = Object.keys(vocabulary[state.currentUnit]).filter(g => g !== 'groupBonus');
                const levels = ['A2', 'B1', 'B2', 'C1'];
                groups.forEach(g => levels.forEach(l => allTests.push(`${g}-${l}`)));
                
                const passedAll100 = allTests.every(test => {
                    const [group, level] = test.split('-');
                    return allScoresForUnit.some(s => s.group === group && s.level === level && s.score === 100);
                });

                if (passedAll100) {
                    addBadge('legend');
                    updateBonusButtonVisibility();
                }
            }
            
            if (state.currentGroup === 'groupBonus' && score === 100) {
                addBadge('alien');
            }

            if (earnedBadges[`legend_${state.currentUnit}`] && earnedBadges[`alien_${state.currentUnit}`]) {
                 addBadge('unit_master');
            }
            
            const allUnitKeys = Object.keys(vocabulary);
            const hasMasteredAllUnits = allUnitKeys.every(unitKey => 
                earnedBadges[`legend_${unitKey}`] && earnedBadges[`alien_${unitKey}`]
            );

            if (hasMasteredAllUnits && !earnedBadges['cute_cat']) {
                addBadge('cute_cat'); 
            }

            if (newlyEarned.length > 0) {
                await updateBadgesInFirestore();
            }

            return newlyEarned;
        };
        
        const updateBonusButtonVisibility = () => {
             const currentUnitKey = state.currentUnit;
             const legendBadgeKey = `legend_${currentUnitKey}`;
            if (earnedBadges[legendBadgeKey]) {
                dom.bonusGroupBtn.classList.remove('hidden');
            } else {
                dom.bonusGroupBtn.classList.add('hidden');
            }
        };
        
        const fetchBadges = async () => {
             if (!userId) return;
             const badgeRef = doc(db, `artifacts/${appId}/public/data/user_badges`, userId);
             try {
                 const docSnap = await getDoc(badgeRef);
                 if (docSnap.exists()) {
                     earnedBadges = docSnap.data().badges || {};
                 } else {
                     earnedBadges = {};
                 }
                 updateBonusButtonVisibility();
                 renderBadgeHall();
             } catch (e) {
                 console.error("Error fetching badges:", e);
                 earnedBadges = {};
             }
        };
        
        const renderBadgeHall = () => {
            const container = dom.badgeHallContainer;
            if (!container) return;
            container.innerHTML = '';
            
            const sortedBadges = Object.keys(allBadges).sort((a, b) => {
                const order = ['effortful_learner', 'high_achiever', 'perfect_score', 'a2_explorer', 'b1_voyager', 'conqueror', 'strong_one', 'english_monster', 'legend', 'alien', 'unit_master', 'cute_cat'];
                return order.indexOf(a) - order.indexOf(b);
            });

            sortedBadges.forEach(key => {
                const badge = allBadges[key];

                let isEarned = false;
                const generalBadges = ['perfect_score', 'high_achiever', 'effortful_learner', 'cute_cat'];
                if (generalBadges.includes(key)) {
                    isEarned = earnedBadges[key] === true;
                } else {
                    const uniqueKey = `${key}_${state.currentUnit}`;
                    isEarned = earnedBadges[uniqueKey] === true;
                }
                
                const badgeHTML = `
                    <div class="flex items-center p-4 bg-white rounded-lg shadow ${isEarned ? 'opacity-100 ring-2 ring-yellow-400' : 'opacity-40'}">
                        <div class="text-4xl mr-4">${badge.icon}</div>
                        <div>
                            <h3 class="font-bold text-lg ${isEarned ? 'text-yellow-600' : 'text-gray-700'}">${badge.name}</h3>
                            <p class="text-sm text-gray-500">${badge.description}</p>
                        </div>
                    </div>
                `;
                container.innerHTML += badgeHTML;
            });
        };
        
        const updateDropdownOptions = () => {
            const allSelects = Array.from(document.querySelectorAll('.word-select'));
            const answeredCount = allSelects.filter(s => s.value !== '').length;
            const totalCount = allSelects.length;
            dom.submitBtn.disabled = totalCount > 0 && answeredCount < Math.ceil(totalCount / 2);

            const selectedValues = new Set(allSelects.map(s => s.value).filter(v => v));
            allSelects.forEach((select, index) => {
                const ownValue = select.value;
                let optionsHtml = `<option value="">---(${index + 1})---</option>`;
                state.currentWords.forEach(word => {
                    if (!selectedValues.has(word) || word === ownValue) {
                        optionsHtml += `<option value="${word}" ${word === ownValue ? 'selected' : ''}>${word}</option>`;
                    }
                });
                select.innerHTML = optionsHtml;
            });
        };
        
        const loadQuiz = () => {
            if (!state.currentUnit || !state.currentGroup || !state.currentDifficulty) return;
            
            dom.quizArea.classList.remove('hidden');
            dom.welcomeMessage.classList.add('hidden');
            
            const isBonus = state.currentGroup === 'groupBonus';
            const unitData = vocabulary[state.currentUnit][state.currentGroup];
            Object.assign(state, { correctAnswers: {}, earnedBadgesForSharing: [] });
            
            dom.storyPassage.innerHTML = '';
            dom.wordOptions.innerHTML = '';
            dom.resultsDiv.innerHTML = '';
            dom.analysisContainer.style.display = 'none';
            dom.incorrectAnswersDiv.innerHTML = '';
            dom.shareBtn.classList.add('hidden');
            dom.submitBtn.disabled = true;

            const selectedStory = isBonus ? unitData.story : unitData.stories.find(s => s.level === state.currentDifficulty);
            state.currentWords = unitData.words.slice().sort((a, b) => a.localeCompare(b));

            let selectCounter = 0;
            const processedStory = selectedStory.text.replace(/\*\*(.*?)\*\*/g, (match, word) => {
                const selectId = `word-select-${selectCounter}`;
                // Store the correct answer with its original casing for the cheater function
                state.correctAnswers[selectId] = word; 
                return `<select id="${selectId}" class="word-select"><option value="">---(${++selectCounter})---</option></select>`;
            });

            dom.storyPassage.innerHTML = processedStory;
            
            dom.storyPassage.querySelectorAll('.word-select').forEach(select => select.addEventListener('change', updateDropdownOptions));
            updateDropdownOptions();
            
            dom.wordOptions.innerHTML = '';
            state.currentWords.forEach(word => {
                const wordBtn = document.createElement('button');
                wordBtn.className = 'word-pronounceable';
                wordBtn.textContent = word;
                wordBtn.addEventListener('click', () => showHint(word));
                dom.wordOptions.appendChild(wordBtn);
            });

            renderBadgeHall();
        };
        
        const speak = (text, rate = 1.0) => {
             if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = rate;
                window.speechSynthesis.speak(utterance);
             }
        };
        
        const stopSpeak = () => {
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
        };

        const showHint = (word) => {
            const wordData = wordDetails[state.currentUnit]?.[word.toLowerCase()];

            if (!wordData) {
                console.error(`Word data for "${word}" in unit "${state.currentUnit}" not found.`);
                return;
            }

            dom.modalContent.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="text-left">
                        <h2 class="text-3xl font-bold text-sky-800" id="modal-word-title"></h2>
                        <div id="chinese-translation" class="hidden text-xl text-gray-700 my-2"></div>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button id="modal-word-speak-normal" class="text-2xl" title="正常速度">🔊</button>
                        <button id="modal-word-speak-slow" class="text-2xl" title="慢速">🐢</button>
                        <button id="modal-word-speak-stop" class="text-2xl" title="停止">🤫</button>
                    </div>
                </div>
                <button id="show-chinese-btn" class="mb-4 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold py-1 px-3 rounded-lg">顯示中文</button>
                <p class="text-md text-left text-gray-600"><strong>Definition:</strong> (${wordData.pos}) ${wordData.definition}</p>
                <div class="flex justify-between items-start mt-2">
                    <div class="text-md text-left text-gray-500 pr-4">
                        <strong>Example:</strong> <em id="modal-example-text"></em>
                    </div>
                    <div class="flex items-center space-x-1 flex-shrink-0">
                        <button id="modal-example-speak-normal" class="text-2xl" title="正常速度">🔊</button>
                        <button id="modal-example-speak-slow" class="text-2xl" title="慢速">🐢</button>
                        <button id="modal-example-speak-stop-example" class="text-2xl" title="停止">🤫</button>
                    </div>
                </div>
                <div id="example-translation-tw" class="hidden text-md text-left text-gray-500 mt-1"><strong>翻譯:</strong> <em id="modal-example-translation-text"></em></div>
                <button id="show-example-translation-btn" class="mt-2 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold py-1 px-3 rounded-lg">顯示例句翻譯</button>`;
            
            document.getElementById('modal-word-title').textContent = word;
            document.getElementById('chinese-translation').textContent = `(${wordData.pos}) ${wordData.translation}`;
            document.getElementById('modal-example-text').textContent = wordData.example;
            document.getElementById('modal-example-translation-text').textContent = wordData.example_tw;

            document.getElementById('modal-word-speak-normal').addEventListener('click', () => speak(word, 1.0));
            document.getElementById('modal-word-speak-slow').addEventListener('click', () => speak(word, 0.7));
            document.getElementById('modal-word-speak-stop').addEventListener('click', stopSpeak);
            document.getElementById('modal-example-speak-normal').addEventListener('click', () => speak(wordData.example, 1.0));
            document.getElementById('modal-example-speak-slow').addEventListener('click', () => speak(wordData.example, 0.7));
            document.getElementById('modal-example-speak-stop-example').addEventListener('click', stopSpeak);

            const setupShowButton = (btnId, targetId) => {
                document.getElementById(btnId)?.addEventListener('click', (e) => {
                    document.getElementById(targetId)?.classList.remove('hidden');
                    e.target.style.display = 'none';
                });
            };
            setupShowButton('show-chinese-btn', 'chinese-translation');
            setupShowButton('show-example-translation-btn', 'example-translation-tw');

            dom.hintModal.style.display = 'block';
        };

        const checkAnswers = async () => {
            let correctCount = 0;
            const totalCount = Object.keys(state.correctAnswers).length;
            dom.incorrectAnswersDiv.innerHTML = '<h3 class="text-lg font-bold text-red-600">訂正錯誤：</h3>';
            let hasIncorrect = false;

            for (const selectId in state.correctAnswers) {
                const selectElement = document.getElementById(selectId);
                const correctAnswer = state.correctAnswers[selectId];
                const selectedAnswer = selectElement.value;
                selectElement.classList.remove('correct', 'incorrect');

                if (selectedAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                    selectElement.classList.add('correct');
                    correctCount++;
                } else {
                    selectElement.classList.add('incorrect');
                    hasIncorrect = true;
                    
                    const wordData = wordDetails[state.currentUnit]?.[correctAnswer.toLowerCase()];

                    if (wordData) {
                        dom.incorrectAnswersDiv.innerHTML += `<div class="p-4 bg-red-50 rounded-lg border border-red-200"><p>您選擇了 <strong class="text-red-500">${selectElement.value || "（未選擇）"}</strong>，正確答案是 <strong class="text-green-600">${correctAnswer.charAt(0).toUpperCase() + correctAnswer.slice(1)}</strong>。</p><p class="text-sm text-gray-600">(${wordData.pos}) ${wordData.translation} - ${wordData.definition}</p></div>`;
                    }
                }
                selectElement.disabled = true;
            }

            state.currentScore = Math.round((correctCount / totalCount) * 100);
            dom.resultsDiv.innerHTML = `<span class="text-blue-600">答對 ${correctCount} / ${totalCount} 題</span> <span class="text-green-600">分數: ${state.currentScore}</span>`;
            
            if (hasIncorrect) dom.analysisContainer.style.display = 'block';
            
            dom.submitBtn.disabled = true;
            dom.shareBtn.classList.remove('hidden');
            
            await saveScore(state.currentScore);
            state.earnedBadgesForSharing = await checkAchievements(state.currentScore);

            await fetchScores(); 
            await fetchBadges();
            
            if(state.earnedBadgesForSharing.length > 0) {
                dom.resultsDiv.innerHTML += `<div class="mt-4 text-yellow-600 font-semibold">恭喜！您獲得了新的徽章！</div>`;
            }
            renderBadgeHall();
        };

        const saveScore = async (score) => {
            if (!db || !userId) return;
            const { value: studentClass } = dom.classSelect;
            const { value: seatNumber } = dom.seatNumberInput;
            const { options, selectedIndex } = dom.unitSelect;
            const unitText = options[selectedIndex].text;
            
            const existingScoreIndex = localScores.findIndex(s => s.unitKey === state.currentUnit && s.group === state.currentGroup && s.level === state.currentDifficulty);
            if (existingScoreIndex > -1) {
                if (score > localScores[existingScoreIndex].score) {
                    localScores[existingScoreIndex].score = score;
                }
            } else {
                localScores.push({unitKey: state.currentUnit, group: state.currentGroup, level: state.currentDifficulty, score});
            }

            if (seatNumber.trim()) {
                 const newScoreData = {
                    userId, studentClass, seatNumber: seatNumber.padStart(2, '0'),
                    unit: unitText,
                    unitKey: state.currentUnit,
                    group: state.currentGroup, level: state.currentDifficulty, score,
                    timestamp: serverTimestamp()
                };
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/${pageIdentifier}_scores`), newScoreData);
                } catch (e) { console.error("Error adding document: ", e); }
            }
        };
        
        const adminFillAnswers = () => {
            for (const selectId in state.correctAnswers) {
                const selectElement = document.getElementById(selectId);
                const correctAnswerValue = state.correctAnswers[selectId];
                const matchingWord = state.currentWords.find(w => w.toLowerCase() === correctAnswerValue.toLowerCase());
                if (selectElement && matchingWord) {
                    selectElement.value = matchingWord;
                }
            }
            updateDropdownOptions();
        };

        const clearCurrentAnswers = () => {
            dom.storyPassage.querySelectorAll('.word-select').forEach(select => {
                select.value = '';
                select.classList.remove('correct', 'incorrect');
                select.disabled = false;
            });
            dom.resultsDiv.innerHTML = '';
            dom.analysisContainer.style.display = 'none';
            dom.incorrectAnswersDiv.innerHTML = '';
            dom.shareBtn.classList.add('hidden');
            dom.submitBtn.disabled = true;
            updateDropdownOptions();
        };

        const resetQuizArea = () => {
            dom.quizArea.classList.add('hidden');
            dom.welcomeMessage.classList.remove('hidden');
            state.currentGroup = null;
            state.currentDifficulty = null;
            dom.groupSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            dom.difficultySelector.querySelectorAll('.difficulty-btn-wrapper').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('disabled');
            });
        };

        const getEarnedBadgesForImage = () => {
            const collectedBadges = new Map();
            const generalBadgeKeys = ['effortful_learner', 'high_achiever', 'perfect_score', 'cute_cat'];

            generalBadgeKeys.forEach(key => {
                if (earnedBadges[key]) {
                    const badge = allBadges[key];
                    if (badge && !collectedBadges.has(badge.name)) {
                        collectedBadges.set(badge.name, badge);
                    }
                }
            });

            Object.keys(earnedBadges).forEach(key => {
                if (!generalBadgeKeys.includes(key)) {
                    const badgeId = key.substring(0, key.lastIndexOf('_'));
                    const badge = allBadges[badgeId];
                    if (badge && !collectedBadges.has(badge.name)) {
                        collectedBadges.set(badge.name, badge);
                    }
                }
            });
            return Array.from(collectedBadges.values());
        };

        const drawBadgeSection = (ctx, title, badges, startY, highlight = false) => {
            if (badges.length === 0) return startY;
            
            let currentY = startY;
            ctx.font = 'bold 28px "Noto Sans TC", sans-serif';
            ctx.fillStyle = highlight ? '#c2410c' : '#004d40';
            ctx.textAlign = 'center';
            ctx.fillText(title, ctx.canvas.width / 2, currentY);
            currentY += 50;
            
            const catBadge = badges.find(b => b.name === "可愛貓貓");
            const otherBadges = badges.filter(b => b.name !== "可愛貓貓");

            const badgesPerRow = 3;
            const rowCount = Math.ceil(otherBadges.length / badgesPerRow);

            for (let i = 0; i < rowCount; i++) {
                const rowBadges = otherBadges.slice(i * badgesPerRow, (i + 1) * badgesPerRow);
                
                const badgeDimensions = rowBadges.map(b => ({
                    badge: b, width: 220, height: 65
                }));
                
                const totalRowWidth = badgeDimensions.reduce((sum, dim) => sum + dim.width, 0) + (rowBadges.length - 1) * 20;
                let currentX = (ctx.canvas.width - totalRowWidth) / 2;
                
                badgeDimensions.forEach(dim => {
                    const { badge, width, height } = dim;
                    
                    ctx.fillStyle = '#ffffff'; 
                    ctx.strokeStyle = highlight ? '#f59e0b' : '#00796b'; 
                    ctx.lineWidth = highlight ? 5 : 3;
                    ctx.beginPath();
                    if (ctx.roundRect) ctx.roundRect(currentX, currentY, width, height, 20);
                    else ctx.rect(currentX, currentY, width, height);
                    ctx.fill();
                    ctx.stroke();
                    
                    ctx.font = '40px sans-serif'; 
                    ctx.fillStyle = '#004d40';
                    ctx.textAlign = 'left';
                    ctx.fillText(badge.icon, currentX + 20, currentY + 47);
                    
                    ctx.font = '28px "Noto Sans TC", sans-serif';
                    ctx.fillText(badge.name, currentX + 75, currentY + 43);
                    
                    currentX += width + 20;
                });

                currentY += 65 + 15;
            }
            
            if (catBadge) {
                currentY += 10;
                const width = 300;
                const height = 80;
                const startX = (ctx.canvas.width - width) / 2;
                
                ctx.fillStyle = '#ffffff'; 
                ctx.strokeStyle = highlight ? '#f59e0b' : '#00796b'; 
                ctx.lineWidth = highlight ? 5 : 3;
                ctx.beginPath();
                if (ctx.roundRect) ctx.roundRect(startX, currentY, width, height, 20);
                else ctx.rect(startX, currentY, width, height);
                ctx.fill();
                ctx.stroke();
                
                ctx.font = '50px sans-serif'; 
                ctx.fillStyle = '#004d40';
                ctx.textAlign = 'left';
                ctx.fillText(catBadge.icon, startX + 20, currentY + 58);
                
                ctx.font = '30px "Noto Sans TC", sans-serif';
                ctx.fillText(catBadge.name, startX + 85, currentY + 52);

                currentY += height + 15;
            }

            return currentY + 30;
        };
        
        const shareSingleScore = () => {
            if (!dom.seatNumberInput.value.trim()) { 
                dom.modalContent.innerHTML = `<p class="text-red-600 font-semibold">請先輸入有效的班級座號才能分享！</p>`;
                dom.hintModal.style.display = 'block'; 
                return; 
            }

            let allEarnedBadgesForImage = getEarnedBadgesForImage();
            const newlyEarnedBadges = state.earnedBadgesForSharing.map(b => allBadges[b.key]);

            const newlyEarnedNames = new Set(newlyEarnedBadges.map(b => b.name));
            allEarnedBadgesForImage = allEarnedBadgesForImage.filter(b => !newlyEarnedNames.has(b.name));

            const canvas = document.getElementById('shareCanvas');
            let canvasHeight = 420;
            if (newlyEarnedBadges.length > 0) canvasHeight += 100 + Math.ceil(newlyEarnedBadges.length / 3) * 85 + (newlyEarnedBadges.some(b => b.name === '可愛貓貓') ? 20 : 0);
            if (allEarnedBadgesForImage.length > 0) canvasHeight += 100 + Math.ceil(allEarnedBadgesForImage.length / 3) * 85 + (allEarnedBadgesForImage.some(b => b.name === '可愛貓貓') ? 20 : 0);
            canvas.height = canvasHeight;
            
            const ctx = canvas.getContext('2d');
            const { value: studentClass } = dom.classSelect;
            const seatNumber = dom.seatNumberInput.value.padStart(2, '0');
            const group = state.currentGroup === 'groupBonus' ? '傳說級' : `Group ${state.currentGroup.slice(-1)}`;
            const { options, selectedIndex } = dom.unitSelect;
            const unitText = options[selectedIndex].text;
            
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#e0f7fa'); 
            gradient.addColorStop(1, '#b2ebf2');
            ctx.fillStyle = gradient; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#004d40'; 
            ctx.font = 'bold 55px "Noto Sans TC", sans-serif';
            ctx.textAlign = 'center'; 
            ctx.fillText('成績單', canvas.width / 2, 80);
            
            ctx.fillStyle = '#00796b'; 
            ctx.font = '36px "Noto Sans TC", sans-serif';
            ctx.fillText(`${studentClass} ${seatNumber}號`, canvas.width / 2, 140);
            
            ctx.font = '30px "Noto Sans TC", sans-serif';
            ctx.fillText(`測驗: ${unitText} - ${group} ${state.currentGroup !== 'groupBonus' ? `(${state.currentDifficulty})` : ''}`, canvas.width / 2, 190);
            
            ctx.fillStyle = state.currentScore >= 80 ? '#2e7d32' : (state.currentScore >= 60 ? '#f57f17' : '#c62828');
            ctx.font = 'bold 110px "Inter", sans-serif'; 
            ctx.fillText(state.currentScore, canvas.width / 2, 300);
            ctx.font = 'bold 45px "Noto Sans TC", sans-serif';
            ctx.fillText('分', canvas.width / 2 + 100, 300);

            let currentY = 350;
            currentY = drawBadgeSection(ctx, "本次新獲得！", newlyEarnedBadges, currentY, true);
            currentY = drawBadgeSection(ctx, "已獲得的所有徽章", allEarnedBadgesForImage, currentY);
            
            ctx.textAlign = 'center'; 
            ctx.fillStyle = '#004d40'; 
            ctx.font = '20px "Noto Sans TC", sans-serif';
            ctx.fillText(`測驗日期: ${new Date().toLocaleDateString('zh-TW')}`, canvas.width / 2, currentY + 10);

            const dataUrl = canvas.toDataURL('image/png');
            const newlyEarnedBadgesHtml = newlyEarnedBadges.length > 0 ? `<div class="mt-4 p-3 bg-yellow-50 rounded-lg"><h4 class="text-lg font-semibold text-yellow-800">您本次新獲得的徽章：</h4><div class="flex justify-center flex-wrap gap-2 mt-2">${newlyEarnedBadges.map(badge => `<span class="bg-white border border-yellow-300 rounded-full px-3 py-1 text-sm font-medium text-gray-700">${badge.icon} ${badge.name}</span>`).join('')}</div></div>` : '';
            dom.modalContent.innerHTML = `<h3 class="text-xl font-semibold mb-4">您的成績單圖片</h3>${newlyEarnedBadgesHtml}<p class="text-gray-600 my-4">請長按 (電腦請按右鍵) 圖片以儲存並分享。</p><p class="text-sm text-blue-600 bg-blue-50 p-2 rounded-md mb-4"><strong>iPhone/iPad 使用者：</strong>請長按圖片，然後選擇「儲存到照片」。圖片會存放在您的「照片」App中。</p><img src="${dataUrl}" alt="成績單圖片" class="w-full rounded-lg shadow-md" /><a href="${dataUrl}" download="單字複習-成績單.png" class="mt-4 inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-full">下載圖片</a>`;
            dom.hintModal.style.display = 'block';
        };

        const shareAchievements = () => {
             if (!dom.seatNumberInput.value.trim()) { 
                 dom.modalContent.innerHTML = `<p class="text-red-600 font-semibold">請先輸入班級座號才能分享！</p>`;
                 dom.hintModal.style.display = 'block'; 
                 return; 
             }
            
            const allEarnedBadgesForImage = getEarnedBadgesForImage();
            const totalTests = localScores.length;
            const highScore = totalTests > 0 ? Math.max(...localScores.map(s => s.score)) : 0;
            
            const canvas = document.getElementById('shareCanvas');
            let canvasHeight = 450;
            if (allEarnedBadgesForImage.length > 0) canvasHeight += 100 + Math.ceil(allEarnedBadgesForImage.length / 3) * 85 + (allEarnedBadgesForImage.some(b => b.name === '可愛貓貓') ? 20 : 0);
            canvas.height = canvasHeight;
            
            const ctx = canvas.getContext('2d');
            const { value: studentClass } = dom.classSelect;
            const seatNumber = dom.seatNumberInput.value.padStart(2, '0');

            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#f3e8ff'); 
            gradient.addColorStop(1, '#d8b4fe');
            ctx.fillStyle = gradient; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#4a044e';
            ctx.font = 'bold 60px "Noto Sans TC", sans-serif';
            ctx.textAlign = 'center'; 
            ctx.fillText('學習成就總覽', canvas.width / 2, 100);
            
            ctx.fillStyle = '#6b21a8';
            ctx.font = '40px "Noto Sans TC", sans-serif';
            ctx.fillText(`${studentClass} ${seatNumber}號`, canvas.width / 2, 180);
            
            ctx.font = 'bold 32px "Inter", sans-serif';
            ctx.fillStyle = '#3b0764';
            ctx.fillText(`總完成測驗: ${totalTests}次`, canvas.width / 2, 250);
            ctx.fillText(`最高分紀錄: ${highScore}分`, canvas.width / 2, 300);

            let currentY = drawBadgeSection(ctx, "我的徽章牆", allEarnedBadgesForImage, 380);
            
            ctx.textAlign = 'center'; 
            ctx.fillStyle = '#4a044e'; 
            ctx.font = '20px "Noto Sans TC", sans-serif';
            ctx.fillText(`分享日期: ${new Date().toLocaleDateString('zh-TW')}`, canvas.width / 2, currentY + 10);

            const dataUrl = canvas.toDataURL('image/png');
            dom.modalContent.innerHTML = `<h3 class="text-xl font-semibold mb-4">您的學習成就總覽</h3><p class="text-gray-600 my-4">請長按 (電腦請按右鍵) 圖片以儲存並分享。</p><p class="text-sm text-blue-600 bg-blue-50 p-2 rounded-md mb-4"><strong>iPhone/iPad 使用者：</strong>請長按圖片，然後選擇「儲存到照片」。圖片會存放在您的「照片」App中。</p><img src="${dataUrl}" alt="學習成就圖片" class="w-full rounded-lg shadow-md" /><a href="${dataUrl}" download="學習成就總覽.png" class="mt-4 inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-full">下載圖片</a>`;
            dom.hintModal.style.display = 'block';
        };
        
        dom.unitSelect.addEventListener('change', (e) => {
            state.currentUnit = e.target.value;
            fetchScores().then(() => {
                fetchBadges();
            });
            resetQuizArea();
        });

        dom.groupSelector.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && state.currentUnit) {
                const group = button.dataset.group;
                state.currentGroup = group;
                
                dom.groupSelector.querySelectorAll('button').forEach(btn => btn.classList.toggle('active', btn.dataset.group === group));
                
                if (group === 'groupBonus') {
                    state.currentDifficulty = 'C2';
                    dom.difficultySelector.querySelectorAll('.difficulty-btn-wrapper').forEach(btn => {
                        btn.classList.add('disabled');
                        btn.classList.remove('active');
                    });
                    loadQuiz();
                } else {
                    state.currentDifficulty = null;
                    dom.difficultySelector.querySelectorAll('.difficulty-btn-wrapper').forEach(btn => {
                        btn.classList.remove('disabled', 'active');
                    });
                    dom.quizArea.classList.add('hidden');
                    dom.welcomeMessage.classList.remove('hidden');
                }
            }
        });

        dom.difficultySelector.addEventListener('click', (e) => {
            const button = e.target.closest('.difficulty-btn-wrapper');
            if (button && !button.classList.contains('disabled')) {
                const level = button.dataset.level;
                state.currentDifficulty = level;
                dom.difficultySelector.querySelectorAll('.difficulty-btn-wrapper').forEach(btn => btn.classList.toggle('active', btn.dataset.level === level));
                loadQuiz();
            }
        });

        dom.seatNumberInput.addEventListener('input', (e) => {
            try {
                if (btoa(e.target.value) === ADMIN_PASS_B64) {
                    dom.adminTools.classList.remove('hidden');
                    dom.devToolsPanel.classList.remove('hidden');
                } else {
                    dom.adminTools.classList.add('hidden');
                    dom.devToolsPanel.classList.add('hidden');
                }
            } catch (error) {
                dom.adminTools.classList.add('hidden');
                dom.devToolsPanel.classList.add('hidden');
            }
        });
        
        document.addEventListener('DOMContentLoaded', async () => await signIn());
        dom.submitBtn.addEventListener('click', checkAnswers);
        dom.clearBtn.addEventListener('click', clearCurrentAnswers);
        dom.shareBtn.addEventListener('click', shareSingleScore);
        dom.shareAchievementsBtn.addEventListener('click', shareAchievements);
        dom.adminFillBtn.addEventListener('click', adminFillAnswers);

        dom.closeModalBtn.addEventListener('click', () => { dom.hintModal.style.display = 'none'; stopSpeak(); });
        window.addEventListener('click', (event) => { if (event.target == dom.hintModal) { dom.hintModal.style.display = 'none'; stopSpeak(); } });

        // Dev Tools Logic
        dom.unlockAllBtn.addEventListener('click', async () => {
            Object.keys(allBadges).forEach(key => {
                const generalBadges = ['perfect_score', 'high_achiever', 'effortful_learner', 'cute_cat'];
                if (generalBadges.includes(key)) {
                    earnedBadges[key] = true;
                } else {
                     Object.keys(vocabulary).forEach(unitKey => {
                         earnedBadges[`${key}_${unitKey}`] = true;
                     });
                }
            });
            await updateBadgesInFirestore();
            renderBadgeHall();
            updateBonusButtonVisibility();
            alert('所有徽章已解鎖！');
        });

        dom.clearAllBtn.addEventListener('click', async () => {
            earnedBadges = {};
            await updateBadgesInFirestore();
            renderBadgeHall();
            updateBonusButtonVisibility();
            alert('所有徽章已清除！');
        });

        dom.testAchievementShare.addEventListener('click', () => {
            shareAchievements();
        });

        dom.testScoreShare.addEventListener('click', () => {
             // Mock some data for a test score card
            state.currentScore = 100;
            state.earnedBadgesForSharing = [
                allBadges.perfect_score,
                allBadges.unit_master,
                allBadges.cute_cat
            ];
            state.currentGroup = 'groupBonus';
            state.currentDifficulty = 'C2';
            shareSingleScore();
        });

        // Polyfills for older browsers
        if (CanvasRenderingContext2D.prototype.roundRect === undefined) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                this.beginPath();
                this.moveTo(x + radius, y); this.lineTo(x + width - radius, y); this.quadraticCurveTo(x + width, y, x + width, y + radius);
                this.lineTo(x + width, y + height - radius); this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                this.lineTo(x + radius, y + height); this.quadraticCurveTo(x, y + height, x, y + height - radius); this.lineTo(x, y + radius);
                this.quadraticCurveTo(x, y, x + radius, y); this.closePath();
            };
        }
    </script>
</body>
</html>
